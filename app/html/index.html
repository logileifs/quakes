<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8' />
	<title>Skj√°lftar</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />
	<style>
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}

		#map {
			position: absolute;
			top: 0;
			bottom: -30px;
			width: 100%;
		}

		.quakeInfo {
			position: absolute;
			font-family: sans-serif;
			margin-top: 5px;
			margin-left: 5px;
			padding: 5px;
			width: 30%;
			border: 2px solid black;
			font-size: 18px;
			color: white;
			/* background-color: #fff; */
			-webkit-text-stroke-color: black;
			border-radius: 3px;
			-webkit-text-stroke-width: 0.5px;
		}

		.ticker {
			position: fixed;
			font-family: sans-serif;
			width: 100%;
			height: 20%;
			border: 1px solid black;
			font-size: 14px;
			color: #222;
			background-color: transparent;
			bottom: 0;
		}

		.table {
			position: fixed;
			font-family: sans-serif;
			width: 10%;
			height: 79%;
			border: 1px solid black;
			font-size: 14px;
			color: #222;
			background-color: transparent;
			right: 0;
			display: none;
		}

		#myChart {
			width: 100%;
			height: 100%;
		}

		#menu {
			position: absolute;
			/*background: #efefef;*/
			padding: 10px;
			margin: 0 auto;
			font-family: 'Open Sans', sans-serif;
			color: white;
		}
	</style>
</head>

<body style="display: flex; justify-content: center;">
	<div id='map'></div>
	<div id="menu">
		<input id="satellite-v9" type="radio" name="rtoggle" value="satellite" checked="checked">
		<!-- See a list of Mapbox-hosted public styles at https://docs.mapbox.com/api/maps/styles/#mapbox-styles -->
		<label for="satellite-v9">satellite</label>
		<input id="light-v10" type="radio" name="rtoggle" value="light">
		<label for="light-v10">light</label>
		<input id="dark-v10" type="radio" name="rtoggle" value="dark">
		<label for="dark-v10">dark</label>
		<input id="streets-v11" type="radio" name="rtoggle" value="streets">
		<label for="streets-v11">streets</label>
		<input id="outdoors-v11" type="radio" name="rtoggle" value="outdoors">
		<label for="outdoors-v11">outdoors</label>
	</div>
	<div id='ticker' class='ticker'>
		<canvas id='chart' style="width: 100%; height: 100%;"></canvas>
	</div>
	<div class='table'></div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script>
		var chart;
		var quakes;
		var switchLayers = false
		var defaultStyle = 'light-v10'
		var ctx = document.getElementById('chart').getContext('2d');
		mapboxgl.accessToken = 'pk.eyJ1IjoibG9naWxlaWZzIiwiYSI6ImNrbTk4bzRwazFmanIycWtuaXdnbnZ0ZTAifQ.eJjqmhjSLkP5eCXQGto8tA';
		var map = new mapboxgl.Map({
			container: 'map', // Specify the container ID
			//style: 'mapbox://styles/mapbox/outdoors-v11', // Specify which map style to use
			//style: 'mapbox://styles/mapbox/satellite-v9',
			//style: 'mapbox://styles/mapbox/dark-v10',
			style: 'mapbox://styles/mapbox/light-v10',
			center: [-19.020835, 64.963051],
			zoom: 6.0 // Specify the starting zoom
		});

		var layerList = document.getElementById('menu');
		var inputs = layerList.getElementsByTagName('input');
		radioButton = document.getElementById(defaultStyle)
		radioButton.checked = true

		function switchLayer(layer) {
			console.log('switchLayer')
			var layerId = layer.target.id;
			map.setStyle('mapbox://styles/mapbox/' + layerId);
			if (map.getLayer('earthquakes-heat')) map.removeLayer('earthquakes-heat');
			if (map.getLayer('earthquakes-point')) map.removeLayer('earthquakes-point');
			if (map.getLayer('earthquake-labels')) map.removeLayer('earthquake-labels');
			if (map.getSource('earthquakes')) map.removeSource('earthquakes');
			switchLayers = true
			//addSource()
			//addLayers()
		}

		for (var i = 0; i < inputs.length; i++) {
			inputs[i].onclick = switchLayer;
		}

		function filterBy(month) {
			var filters = ['==', 'month', month];
			// map.setFilter('earthquake-circles', filters);
			// map.setFilter('earthquake-labels', filters);
			
			// Set the label to the month
			full_date = month * 1000000
			d = new Date(full_date);
			var print_day = d.getDate()  + "-" + (d.getMonth()+1) + "-" + d.getFullYear(); 

			if (d.getMinutes() < 10) {
					var minutes = "0"+d.getMinutes();
			}
			else {
					var minutes = d.getMinutes();
			}
			
			var print_time = d.getHours() + ":" + minutes;
			// document.getElementById('day').textContent = print_day;
			// document.getElementById('time').textContent = print_time;
		}

		chartColors = {
			red: 'rgb(164, 42, 49)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};

		function setChart() {
			var color = Chart.helpers.color;
			chart = new Chart(ctx, {
				type: 'scatter',
				data: {
					datasets: [
						{
							label: '',
							backgroundColor: color(chartColors.red).alpha(0.75).rgbString(),
							data: quakes.features.map(o => {return {'x': o.properties['time'], 'y': o.properties['mag']}}),
						}
					]
				},
				options: {
					title: {
						display: false
					},
					legend: {
						display: false,
						labels: {
							fontSize: 0
						}
					},
					responsive: true,
					scales: {
						xAxes: [{
							type: 'time',
							position: 'bottom',
							time: {
								unit: 'day'
							}
						}],
						yAxes: [{
							ticks: {
								min: 0,
								max: 9,
								stepSize: 3
							}
						}]
					}
				}
			});
		}

		function addLayers() {
			if (map.getLayer('earthquakes-heat')) map.removeLayer('earthquakes-heat');
			if (map.getLayer('earthquakes-point')) map.removeLayer('earthquakes-point');
			if (map.getLayer('earthquake-labels')) map.removeLayer('earthquake-labels');
			map.addLayer({
				'id': 'earthquakes-heat',
				'type': 'heatmap',
				'source': 'earthquakes',
				'maxzoom': 9,
				'paint': {
					// Increase the heatmap weight based on frequency and property magnitude
					'heatmap-weight': [
						'interpolate',
						['linear'],
						['get', 'mag'],
						0,
						0,
						6,
						1
					],
					// Increase the heatmap color weight weight by zoom level
					// heatmap-intensity is a multiplier on top of heatmap-weight
					'heatmap-intensity': [
						'interpolate',
						['linear'],
						['zoom'],
						0,
						1,
						9,
						3
					],
					// Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
					// Begin color ramp at 0-stop with a 0-transparancy color
					// to create a blur-like effect.
					'heatmap-color': [
						'interpolate',
						['linear'],
						['heatmap-density'],
						0,
						'rgba(33,102,172,0)',
						0.2,
						'rgb(103,169,207)',
						0.4,
						'rgb(209,229,240)',
						0.6,
						'rgb(253,219,199)',
						0.8,
						'rgb(239,138,98)',
						1,
						'rgb(178,24,43)'
					],
					// Adjust the heatmap radius by zoom level
					'heatmap-radius': [
						'interpolate',
						['linear'],
						['zoom'],
						0,
						2,
						9,
						20
					],
					// Transition from heatmap to circle layer by zoom level
					'heatmap-opacity': [
						'interpolate',
						['linear'],
						['zoom'],
						7,
						1,
						9,
						0
					]
				}
			});

			map.addLayer({
				"id": "earthquakes-point",
				"type": "circle",
				"source": "earthquakes",
				"minzoom": 7,
				"paint": {
					// Size circle radius by earthquake magnitude and zoom level
					"circle-radius": [
						"interpolate",
						["linear"],
						["zoom"],
						7, [
							"interpolate",
							["linear"],
							["get", "mag"],
							1, 1,
							6, 4
						],
						16, [
							"interpolate",
							["linear"],
							["get", "mag"],
							1, 5,
							6, 50
						]
					],
					// Color circle by earthquake magnitude
					"circle-color": [
						"interpolate",
						["linear"],
						["get", "mag"],
						0, "rgba(33,102,172,0)",
						0.5, "rgb(103,169,207)",
						1, "rgb(209,229,240)",
						2, "rgb(253,219,199)",
						3, "rgb(239,138,98)",
						4, "rgb(178,24,43)"
					],
					"circle-stroke-color": "white",
					"circle-stroke-width": 1,
					// Transition from heatmap to circle layer by zoom level
					"circle-opacity": [
						"interpolate",
						["linear"],
						["zoom"],
						7, 0,
						8, 1
					]
				}
			});

			map.addLayer({
				'id': 'earthquake-labels',
				'type': 'symbol',
				'minzoom': 10,
				'source': 'earthquakes',
				'layout': {
					'text-field': [
						'concat',
						['to-string', ['get', 'mag']],
						''
					],
					'text-font': [
						'Open Sans Bold',
						'Arial Unicode MS Bold'
					],
					'text-size': 8
				},
				'paint': {
					'text-color': 'rgba(0,0,0,0.5)'
				}
			});
		}

		function addSource() {
			if (map.getSource('earthquakes')) map.removeSource('earthquakes');
			map.addSource('earthquakes', {
				'type': 'geojson',
				data: quakes
			});
		}

		map.on('styledata', function() {
			console.log('A styledata event occurred.');
			if (switchLayers == true) {
				setTimeout(function() {
					//alert("Hello");
					addSource()
					addLayers()
				}, 1000);
				switchLayers = false
			}
		});

		map.on('data', function() {
			console.log('A data event occurred.');
		});

		map.on('load', function () {
			console.log('on load')
			d3.json(
				window.location.origin + '/quakes/' + window.location.search,
				function (err, data) {
					if (err) throw err;
					// Create a month property value based on time
					// used to filter against.
					data.features = data.features.map(function (d) {return d;});
					quakes = data;

					addSource()
					addLayers()
					setChart()
				}
			);
		});

	</script>

</body>

</html>